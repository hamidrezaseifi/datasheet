{% extends "global/base.html" %}
{% load static i18n %}

{% block content %}
<h2>{{ model_name }} {% trans 'bearbeiten' %}</h2>

{% if messages %}
<div class="messages mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<form id="add-objekt-form" method="post" novalidate>
    {% csrf_token %}
    {{ form.as_p }}
    <input type="hidden" name="action" value="add">
    <input type="hidden" name="user_name" value="Anonymous">

    <div>
        <button type="button" class="btn btn-primary" style="width: 130px;" disabled id="btn_add">
            {% trans 'hinzufügen' %}
            <i class="bi bi-plus-circle" style="font-size: 16px;"></i>
        </button>
        <span class="placeholder" style="width: calc(100% - 350px); cursor: default; background: transparent;"></span>
        <button id="save-order" type="button" class="btn btn-success" style="width: 210px;" disabled>
            {% trans 'Reihenfolge speichern' %}
            <i class="bi bi-list-ol" style="font-size: 16px;"></i>
        </button>
    </div>
</form>

<hr>

<h3>{% trans 'Objekte sortieren' %}</h3>
<div class="list-header">
    <span class="col-sort-order">#</span>
    <span class="col-objekt">{% trans 'Objekt' %}</span>
    <span class="col-user">{% trans 'Benutzer' %}</span>
    <span class="col-actions">{% trans 'Aktionen' %}</span>
</div>
<div class="sortable-parent">
    <ul id="sortable-list" class="list-group">
        {% for item in items %}
            <li class="list-group-item objekt-data-item d-flex align-items-center" data-id="{{ item.objekt }}">
                <span class="col-sort-order">{{ item.sort_order }}</span>
                <span class="col-objekt">{{ item.objekt }}</span>
                <span class="col-user">{{ item.user_name|default:'-' }}</span>
                <button class="btn btn-danger delete-btn ms-auto" data-id="{{ item.objekt }}" title="{% trans 'Löschen' %}">
                    <i class="bi bi-trash"></i>
                </button>
            </li>
        {% endfor %}
    </ul>
</div>


<style>
    /* CSS für Header und Ausrichtung */
    .list-header {
        display: flex;
        font-weight: bold;
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .list-group-item {
        display: flex;
        padding: 10px 15px;
    }
    .col-objekt {
        flex: 3;
    }
    .col-sort-order {
        flex: 1;
        max-width: 100px;
    }
    .col-user {
        flex: 2;
    }
    .col-actions {
        flex: 1;
        text-align: right;
    }
    .delete-btn {
        margin-left: 10px;
    }
    .sortable-parent{
        overflow-y: auto;
        height: calc(100vh - 460px);
    }
    .objekt-data-item{
        padding: 2px 15px;
    }
    .objekt-data-item:hover{
        background-color: #ffffee;
    }
</style>

{% endblock %}

{% block extra_js %}

<script src="{% static 'js/Sortable.min.js' %}"></script>

<script>
// Initialisiert Sortable.js für Drag & Drop
let sortable = new Sortable(document.getElementById('sortable-list'), {
    animation: 150,
    onSort: function (evt) {
		$('#save-order').prop("disabled", false );
	},
});

// Funktion zum Abrufen des CSRF-Tokens
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Speichert die neue Sortierreihenfolge
$('#save-order').on('click', function () {
    const order = [];
    $('#sortable-list li').each(function () {
        order.push($(this).data('id'));
    });
    showLoading("");

    $.ajax({
        url: "{{ save_url }}",
        method: "POST",
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: {
            action: 'update_order',
            'order[]': order
        },
        success: function () {
            location.reload();
            hideLoading("");
        },
        error: function (xhr) {
            hideLoading("");
            showError("{% trans 'Fehler bei Speichern von Sortierreihenfolge!' %}", xhr.responseJSON?.message);
            console.error(xhr.responseJSON?.message || xhr.statusText);
        }
    });
});

// Handhabt das Hinzufügen eines neuen Objekts
$('#btn_add').on('click', function (e) {
    e.preventDefault();
    alert($('#add-objekt-form').serialize());
    showLoading("");
    $.ajax({
        url: "{{ add_url }}",
        method: "POST",
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        data: $('#add-objekt-form').serialize(),
        success: function (response) {
            if (response.items) {
                updateSortableList(response.items);
                $('#add-objekt-form')[0].reset();
            }
            hideLoading("");
            location.reload();
        },
        error: function (xhr) {
            hideLoading("");
            showError("{% trans 'Fehler bei Hinzufügen!' %}", xhr.responseJSON?.message);
            console.error(xhr.responseJSON?.message || xhr.statusText);
        }
    });
});

// Funktion zum dynamischen Aktualisieren der Liste
function updateSortableList(items) {
    const $sortableList = $('#sortable-list');
    $sortableList.empty();
    for (const item of items) {
        $sortableList.append(`
            <li class="list-group-item d-flex align-items-center" data-id="${item.objekt}">
                <span class="col-objekt">${item.objekt}</span>
                <span class="col-sort-order">${item.sort_order}</span>
                <span class="col-user">${item.user || '-'}</span>
                    <button class="btn btn-danger delete-btn ms-auto" data-id="${item.objekt}" title="Löschen">
                        <button class="btn btn-danger delete-btn ms-auto" data-id="{{ item.objekt }}" title="{% trans 'Löschen' %}">
                        <i class="bi bi-trash"></i>
                    </button>
                </button>
            </li>
        `);
    }
}

function validateAdd(){
    var obj = $("#id_objekt").val();
    var order = $("#id_sort_order").val();
    var disable = true;
    if(obj && obj != "" && obj != null){
        if(order && order != "" && order != null){
            disable = false;
        }
    }

    $("#btn_add").prop("disabled", disable );

}

// Löschen eines Objekts via Ajax
$(document).on('click', '.delete-btn', function () {
    const objekt = $(this).data('id');
    if (confirm("{% trans 'Möchten Sie dieses Objekt wirklich löschen?' %}")) {
        showLoading("");
        $.ajax({
            url: "{{ delete_url }}",
            method: "POST",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: {
                action: 'delete',
                objekt: objekt
            },
            success: function () {
                location.reload();
                hideLoading("");
            },
            error: function (xhr) {
                hideLoading("");
                showError("{% trans 'Fehler bei Löschen!' %}", xhr.responseJSON?.message);
                console.error(xhr.responseJSON?.message || xhr.statusText);
            }
        });
    }
});

$(document).ready(function(){


});


</script>
{% endblock %}
